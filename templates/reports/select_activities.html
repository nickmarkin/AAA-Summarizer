{% extends 'base.html' %}

{% block title %}Select Activities - Academic Achievement Summarizer{% endblock %}

{% block page_title %}Select Activities{% endblock %}

{% block content %}
<h1>Select Activity Types</h1>
<p class="subtitle">Choose which activity types to include in the report</p>

<div class="actions" style="margin-bottom: 15px;">
    <form method="get" style="display: inline;">
        <label>Academic Year:</label>
        <select name="year" onchange="this.form.submit()">
            {% for year in years %}
            <option value="{{ year.year_code }}" {% if year.year_code == academic_year.year_code %}selected{% endif %}>
                AY {{ year.year_code }}{% if year.is_current %} (Current){% endif %}
            </option>
            {% endfor %}
        </select>
    </form>
</div>

<form method="post" action="{% url 'db_export_activities' %}">
    {% csrf_token %}
    <input type="hidden" name="year_code" value="{{ academic_year.year_code }}">

    <div class="actions" style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 15px;">
        <button type="button" onclick="selectAll()" class="btn btn-secondary">Select All</button>
        <button type="button" onclick="deselectAll()" class="btn btn-secondary">Deselect All</button>
        <span id="selection-count">0 selected</span>

        <span style="margin-left: 10px;">Format:</span>
        <select name="format" id="format">
            <option value="pdf">PDF</option>
            <option value="md">Markdown</option>
        </select>

        <span>Sort:</span>
        <select name="sort" id="sort">
            <option value="faculty">Faculty Name</option>
            <option value="date">Date</option>
            <option value="points">Points</option>
        </select>

        <button type="submit" class="btn btn-success">Export Selected</button>
    </div>

    <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding-right: 10px;">
    {% for category, activities in categories.items %}
    <div class="category-section" style="margin-bottom: 0;">
        <div class="category-header">
            {{ category }}
            <button type="button" data-category="{{ category }}" onclick="selectCategory('{{ category }}', this)" style="float: right; background: transparent; border: 1px solid white; color: white; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 12px;">Select All</button>
        </div>
        <div class="category-items">
            {% for act in activities %}
            <div class="checkbox-item">
                <input type="checkbox" name="activities" value="{{ act.key }}" id="act_{{ forloop.parentloop.counter }}_{{ forloop.counter }}" data-category="{{ category }}" onchange="updateCount()">
                <label for="act_{{ forloop.parentloop.counter }}_{{ forloop.counter }}">
                    {{ act.display_name }}
                </label>
                <span class="points">{{ act.count }} entries</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% empty %}
    <div class="card" style="text-align: center; padding: 40px;">
        <p style="color: #666;">No activity data found for this academic year.</p>
        <p><a href="{% url 'import_survey' %}">Import survey data</a> to see activities.</p>
    </div>
    {% endfor %}
    </div>
</form>

<div style="margin-top: 20px;">
    <a href="{% url 'reports_dashboard' %}" class="btn btn-secondary">Back to Reports</a>
</div>
{% endblock %}

{% block scripts %}
<script>
function selectAll() {
    document.querySelectorAll('input[name="activities"]').forEach(cb => cb.checked = true);
    updateCount();
}

function deselectAll() {
    document.querySelectorAll('input[name="activities"]').forEach(cb => cb.checked = false);
    updateCount();
}

function selectCategory(category, btn) {
    const checkboxes = document.querySelectorAll(`input[data-category="${category}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    if (allChecked) {
        // Deselect all
        checkboxes.forEach(cb => cb.checked = false);
        btn.textContent = 'Select All';
    } else {
        // Select all
        checkboxes.forEach(cb => cb.checked = true);
        btn.textContent = 'Deselect All';
    }
    updateCount();
}

function updateCount() {
    const count = document.querySelectorAll('input[name="activities"]:checked').length;
    document.getElementById('selection-count').textContent = count + ' selected';

    // Update all category button labels
    document.querySelectorAll('.category-header button').forEach(btn => {
        const category = btn.getAttribute('data-category');
        const checkboxes = document.querySelectorAll(`input[data-category="${category}"]`);
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        btn.textContent = allChecked ? 'Deselect All' : 'Select All';
    });
}
</script>
{% endblock %}
