{% extends 'base.html' %}

{% block title %}Dashboard - Academic Achievement Summarizer{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block extra_css %}
<style>
    .overview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }
    .overview-card {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }
    .overview-card .value {
        font-size: 32px;
        font-weight: bold;
        color: #2c3e50;
    }
    .overview-card .label {
        font-size: 13px;
        color: #666;
        text-transform: uppercase;
        margin-top: 5px;
    }
    .quarter-status {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }
    .quarter-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 500;
        font-size: 14px;
    }
    .quarter-badge.has-data {
        background: #d4edda;
        color: #155724;
    }
    .quarter-badge.no-data {
        background: #f8d7da;
        color: #721c24;
    }
    .activity-breakdown {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }
    .activity-item {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        text-align: center;
    }
    .activity-item .count {
        font-size: 20px;
        font-weight: bold;
        color: #3498db;
    }
    .activity-item .name {
        font-size: 11px;
        color: #666;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
{% if academic_year %}
<h2>Data Overview - AY {{ academic_year.year_code }}</h2>

<div class="overview-grid">
    <div class="overview-card">
        <div class="value">{{ stats.total_faculty }}</div>
        <div class="label">Total Faculty</div>
    </div>
    <div class="overview-card">
        <div class="value">{{ stats.avc_eligible_faculty }}</div>
        <div class="label">AVC Eligible</div>
    </div>
    <div class="overview-card">
        <div class="value">{{ stats.faculty_with_data }}</div>
        <div class="label">With Survey Data</div>
    </div>
    <div class="overview-card">
        <div class="value">{{ stats.total_activities }}</div>
        <div class="label">Total Activities</div>
    </div>
</div>

<div class="card" style="margin-bottom: 25px;">
    <h3>Quarter Coverage</h3>
    <p style="color: #666; margin-bottom: 15px;">Number of faculty who have reported data for each quarter:</p>
    <div class="quarter-status">
        <span class="quarter-badge {% if stats.q1_q2 > 0 %}has-data{% else %}no-data{% endif %}">
            Q1-Q2: {{ stats.q1_q2 }} faculty
        </span>
        <span class="quarter-badge {% if stats.q3 > 0 %}has-data{% else %}no-data{% endif %}">
            Q3: {{ stats.q3 }} faculty
        </span>
        <span class="quarter-badge {% if stats.q4 > 0 %}has-data{% else %}no-data{% endif %}">
            Q4: {{ stats.q4 }} faculty
        </span>
    </div>

    {% if stats.activity_counts %}
    <h4 style="margin-top: 20px;">Activities by Category</h4>
    <div class="activity-breakdown">
        {% for category, count in stats.activity_counts.items %}
        <div class="activity-item">
            <div class="count">{{ count }}</div>
            <div class="name">{{ category|title }}</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Review Mode Control -->
<div class="card" style="margin-bottom: 25px; {% if academic_year.review_mode_enabled %}border: 2px solid #28a745;{% endif %}">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h3 style="margin: 0;">
                <i class="bi bi-shield-check"></i> Division Chief Review Mode
            </h3>
            <p style="color: #666; margin: 10px 0 0 0;">
                {% if academic_year.review_mode_enabled %}
                <span class="badge bg-success">ENABLED</span>
                Division chiefs can review and verify faculty activities.
                {% else %}
                <span class="badge bg-secondary">DISABLED</span>
                Enable after Q4 surveys close to allow division chiefs to review and verify.
                {% endif %}
            </p>
        </div>
        <div>
            <form method="post" action="{% url 'toggle_review_mode' %}">
                {% csrf_token %}
                {% if academic_year.review_mode_enabled %}
                <button type="submit" class="btn btn-outline-danger">
                    <i class="bi bi-x-circle"></i> Disable Review Mode
                </button>
                {% else %}
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-check-circle"></i> Enable Review Mode
                </button>
                {% endif %}
            </form>
        </div>
    </div>
    {% if academic_year.review_mode_enabled %}
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #dee2e6;">
        <a href="{% url 'divisions_list' %}" class="btn btn-outline-primary">
            <i class="bi bi-diagram-3"></i> View Division Verification Status
        </a>
    </div>
    {% endif %}
</div>
{% endif %}

<h2>Quick Actions</h2>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
    <div class="card">
        <h3>Faculty Roster</h3>
        <p>Manage the department faculty list. Import from Faculty Calculator or add manually.</p>
        <a href="{% url 'roster' %}" class="btn">View Roster</a>
        <a href="{% url 'import_roster' %}" class="btn btn-secondary">Import CSV</a>
    </div>

    <div class="card">
        <h3>Import Survey Data</h3>
        <p>Upload REDCap export and match to faculty roster.</p>
        <a href="{% url 'import_survey' %}" class="btn">Import Survey</a>
        <a href="{% url 'import_history' %}" class="btn btn-secondary">History</a>
    </div>

    <div class="card">
        <h3>Departmental Data</h3>
        <p>Enter teaching awards, evaluations, and other department-tracked items.</p>
        <a href="{% url 'departmental_data' %}" class="btn">Enter Data</a>
    </div>

    <div class="card">
        <h3>Generate Reports</h3>
        <p>Export points summaries and faculty reports with combined data.</p>
        <a href="{% url 'reports_dashboard' %}" class="btn btn-success">Reports</a>
    </div>
</div>

<h2>Quick Upload (Session-Based)</h2>
<div class="card">
    <h3>One-Off CSV Processing</h3>
    <p>For quick processing without saving to database. Data is session-only.</p>

    {% if has_data %}
    <p><strong>You have session data loaded.</strong></p>
    <a href="{% url 'select_export' %}" class="btn btn-success">Continue</a>
    <a href="?clear=1" class="btn btn-secondary">Clear</a>
    {% else %}
    <form method="post" action="{% url 'upload_csv' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="file" name="csv_file" accept=".csv" required>
        <br><br>
        <button type="submit" class="btn btn-secondary">Quick Upload</button>
    </form>
    {% endif %}
</div>
{% endblock %}
