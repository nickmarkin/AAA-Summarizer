{% extends 'base.html' %}

{% block title %}{{ faculty.display_name }} - Academic Achievement Summarizer{% endblock %}

{% block page_title %}{{ faculty.display_name }}{% endblock %}

{% block extra_css %}
<style>
    .summary-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .info-card {
        flex: 1;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 20px;
    }
    .info-card h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #2c3e50;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    .info-table {
        width: 100%;
        font-size: 14px;
    }
    .info-table th {
        text-align: left;
        padding: 8px;
        color: #666;
        width: 40%;
    }
    .info-table td {
        padding: 8px;
    }
    .points-summary {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    .points-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px 20px;
        text-align: center;
        min-width: 120px;
    }
    .points-card.total {
        background: #2c3e50;
        color: white;
    }
    .points-value {
        font-size: 24px;
        font-weight: bold;
        color: #27ae60;
    }
    .points-card.total .points-value {
        color: white;
    }
    .points-label {
        font-size: 12px;
        color: #666;
        text-transform: uppercase;
    }
    .points-card.total .points-label {
        color: rgba(255,255,255,0.7);
    }
    .category-section {
        margin-bottom: 25px;
    }
    .category-header {
        background: #34495e;
        color: white;
        padding: 12px 15px;
        border-radius: 5px 5px 0 0;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .category-total {
        background: rgba(255,255,255,0.2);
        padding: 3px 10px;
        border-radius: 4px;
        font-size: 14px;
    }
    .category-body {
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 5px 5px;
        padding: 15px;
        background: #fafafa;
    }
    .subcategory {
        margin-bottom: 15px;
    }
    .subcategory:last-child {
        margin-bottom: 0;
    }
    .subcategory-title {
        font-weight: 500;
        color: #2c3e50;
        margin-bottom: 8px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }
    .activity-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .activity-item {
        padding: 8px 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 14px;
    }
    .activity-item:last-child {
        border-bottom: none;
    }
    .activity-item:hover {
        background: #f0f0f0;
    }
    .activity-details {
        flex: 1;
    }
    .activity-type {
        font-weight: 500;
        color: #34495e;
    }
    .activity-meta {
        color: #666;
        font-size: 12px;
    }
    .activity-points {
        background: #27ae60;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 13px;
    }
    .source-badge {
        font-size: 10px;
        padding: 2px 5px;
        border-radius: 3px;
        margin-left: 5px;
    }
    .source-badge.manual {
        background: #f39c12;
        color: white;
    }
    .source-badge.survey {
        background: #3498db;
        color: white;
    }
    .dept-badge {
        background: #f39c12;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
    }
    .badge-success {
        background: #28a745;
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
    }
    .badge-warning {
        background: #ffc107;
        color: #212529;
        padding: 3px 8px;
        border-radius: 3px;
    }
    .badge-info {
        background: #17a2b8;
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
    }
    .badge-danger {
        background: #dc3545;
        color: white;
        padding: 3px 8px;
        border-radius: 3px;
    }
    .action-buttons {
        margin-top: 15px;
    }
    .no-data {
        color: #666;
        font-style: italic;
        text-align: center;
        padding: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="action-buttons" style="margin-bottom: 20px;">
    <a href="{% url 'faculty_edit' faculty.email %}" class="btn btn-app">Edit Faculty</a>
    <a href="{% url 'faculty_activities' faculty.email %}" class="btn btn-app btn-secondary">View/Edit Activities</a>
    <a href="{% url 'faculty_portal' faculty.access_token %}" class="btn btn-app btn-secondary" target="_blank">
        <i class="bi bi-box-arrow-up-right"></i> View Portal
    </a>
    <a href="{% url 'roster' %}" class="btn btn-app btn-secondary">Back to Roster</a>
</div>

<!-- Points Summary -->
<div class="points-summary">
    <div class="points-card">
        <div class="points-value">{{ survey_data.citizenship_points|default:0 }}</div>
        <div class="points-label">Citizenship</div>
    </div>
    <div class="points-card">
        <div class="points-value">{{ survey_data.education_points|default:0 }}</div>
        <div class="points-label">Education</div>
    </div>
    <div class="points-card">
        <div class="points-value">{{ survey_data.research_points|default:0 }}</div>
        <div class="points-label">Research</div>
    </div>
    <div class="points-card">
        <div class="points-value">{{ survey_data.leadership_points|default:0 }}</div>
        <div class="points-label">Leadership</div>
    </div>
    <div class="points-card">
        <div class="points-value">{{ survey_data.content_expert_points|default:0 }}</div>
        <div class="points-label">Content Expert</div>
    </div>
    <div class="points-card">
        <div class="points-value">{{ dept_total }}</div>
        <div class="points-label">Departmental</div>
    </div>
    <div class="points-card total">
        <div class="points-value">{{ grand_total }}</div>
        <div class="points-label">Total Points</div>
    </div>
</div>

<div class="summary-row">
    <!-- Faculty Information -->
    <div class="info-card">
        <h3>Faculty Information</h3>
        <table class="info-table">
            <tr><th>Email</th><td>{{ faculty.email }}</td></tr>
            <tr><th>Rank</th><td>{{ faculty.get_rank_display|default:"-" }}</td></tr>
            <tr><th>Contract Type</th><td>{{ faculty.get_contract_type_display|default:"-" }}</td></tr>
            <tr><th>Division</th><td>{{ faculty.division|default:"-" }}</td></tr>
            <tr><th>Status</th><td>{% if faculty.is_active %}<span class="badge-success">Active</span>{% else %}<span class="badge-danger">Inactive</span>{% endif %}</td></tr>
            <tr><th>CCC Member</th><td>{% if faculty.is_ccc_member %}<span class="badge-info">Yes</span> <span class="dept-badge">DEPT</span>{% else %}No{% endif %}</td></tr>
        </table>
    </div>

    <!-- Survey Status -->
    <div class="info-card">
        <h3>Survey Data - AY {{ academic_year.year_code }}</h3>
        {% if survey_data %}
        <table class="info-table">
            <tr><th>Quarters Reported</th><td>{{ survey_data.quarters_reported|join:", "|default:"None" }}</td></tr>
            <tr><th>Status</th><td>{% if survey_data.has_incomplete %}<span class="badge-warning">Incomplete</span>{% else %}<span class="badge-success">Complete</span>{% endif %}</td></tr>
            <tr><th>Survey Total</th><td><strong>{{ survey_total }}</strong> points</td></tr>
        </table>
        {% else %}
        <p class="no-data">No survey data for this academic year.</p>
        {% endif %}
    </div>

    <!-- Departmental Data -->
    <div class="info-card">
        <h3>Departmental Data <span class="dept-badge">DEPT</span></h3>
        {% if dept_data %}
        <table class="info-table">
            <tr><th>New Innovations (80%+)</th><td>{% if dept_data.new_innovations %}Yes{% else %}No{% endif %}</td></tr>
            <tr><th>MyTIP Winner</th><td>{% if dept_data.mytip_winner %}Yes{% else %}No{% endif %}</td></tr>
            <tr><th>MyTIP Count</th><td>{{ dept_data.mytip_count }} mentions</td></tr>
            <tr><th>Teaching Top 25%</th><td>{% if dept_data.teaching_top_25 %}Yes{% else %}No{% endif %}</td></tr>
            <tr><th>Departmental Total</th><td><strong>{{ dept_total }}</strong> points</td></tr>
        </table>
        {% else %}
        <p class="no-data">No departmental data for this year.</p>
        {% endif %}
    </div>
</div>

<!-- Current Survey Invitation -->
{% if current_campaign %}
<div class="summary-row">
    <div class="info-card" style="flex: 1;">
        <h3>Current Survey: {{ current_campaign.name }}</h3>
        {% if current_invitation %}
        <table class="info-table">
            <tr>
                <th>Status</th>
                <td>
                    {% if current_invitation.status == 'submitted' %}
                        <span class="badge-success">Submitted</span>
                    {% elif current_invitation.status == 'in_progress' %}
                        <span class="badge-warning">In Progress</span>
                    {% else %}
                        <span class="badge-danger">Not Started</span>
                    {% endif %}
                </td>
            </tr>
            <tr><th>Email Sent</th><td>{{ current_invitation.email_sent_at|date:"M j, Y g:i A"|default:"Not sent" }}</td></tr>
            <tr><th>First Accessed</th><td>{{ current_invitation.first_accessed_at|date:"M j, Y g:i A"|default:"Never" }}</td></tr>
            {% if current_invitation.status == 'submitted' %}
            <tr><th>Submitted</th><td>{{ current_invitation.submitted_at|date:"M j, Y g:i A" }}</td></tr>
            {% endif %}
        </table>
        <div class="action-buttons" style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="button" class="btn btn-app btn-sm" onclick="copyLink('{{ current_invitation.token }}')" title="Copy survey link">
                <i class="bi bi-link-45deg"></i> Copy Link
            </button>
            <form method="post" action="{% url 'survey:campaign_send' pk=current_campaign.pk %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="single_faculty" value="{{ faculty.email }}">
                <button type="submit" class="btn btn-app btn-sm btn-secondary" title="Resend invitation email">
                    <i class="bi bi-envelope"></i> Resend Email
                </button>
            </form>
            {% if current_invitation.status == 'submitted' %}
            <form method="post" action="{% url 'survey:invitation_unlock' pk=current_invitation.pk %}" style="display: inline;"
                  onsubmit="return confirm('Unlock survey for {{ faculty.display_name }}? They will be able to edit and resubmit.')">
                {% csrf_token %}
                <button type="submit" class="btn btn-app btn-sm btn-warning" title="Unlock for editing">
                    <i class="bi bi-unlock"></i> Unlock
                </button>
            </form>
            {% endif %}
        </div>
        {% else %}
        <p class="no-data">No invitation for this faculty in the current campaign.</p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Activity Details -->
<h2 style="margin-top: 30px; margin-bottom: 20px;">Activity Details</h2>

{% if activity_sections %}
    {% for section in activity_sections %}
    <div class="category-section">
        <div class="category-header">
            <span>{{ section.name }}</span>
            <span class="category-total">Total: {{ section.total }}</span>
        </div>
        <div class="category-body">
            {% for subcat_name, entries in section.subcategories.items %}
            <div class="subcategory">
                <div class="subcategory-title">{{ subcat_name }} ({{ entries|length }})</div>
                <ul class="activity-list">
                    {% for entry in entries %}
                    <li class="activity-item">
                        <div class="activity-details">
                            <span class="activity-type">
                                {% firstof entry.type entry.title entry.name entry.rotations "Activity" %}
                            </span>
                            {% if entry.source == 'manual' %}
                                <span class="source-badge manual">Manual</span>
                            {% endif %}
                            <div class="activity-meta">
                                {% if entry.title and entry.type %}{{ entry.title }}{% endif %}
                                {% if entry.role %} | Role: {{ entry.role }}{% endif %}
                                {% if entry.date %} | {{ entry.date }}{% endif %}
                                {% if entry.conference %} | {{ entry.conference }}{% endif %}
                                {% if entry.journal %} | {{ entry.journal }}{% endif %}
                                {% if entry.society %} | {{ entry.society }}{% endif %}
                                {% if entry.trainee %} | Trainee: {{ entry.trainee }}{% endif %}
                                {% if entry.student %} | Student: {{ entry.student }}{% endif %}
                            </div>
                        </div>
                        <span class="activity-points">{{ entry.points|default:0 }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
{% else %}
    <div class="no-data" style="background: #f8f9fa; padding: 40px; border-radius: 5px;">
        No activity data found for AY {{ academic_year.year_code }}.<br>
        <a href="{% url 'import_survey' %}">Import survey data</a> or
        <a href="{% url 'add_activity' faculty.email %}">add activities manually</a>.
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function copyLink(token) {
    const url = `${window.location.origin}/survey/s/${token}/`;
    navigator.clipboard.writeText(url).then(() => {
        alert('Survey link copied to clipboard!');
    }).catch(err => {
        prompt('Copy this link:', url);
    });
}
</script>
{% endblock %}
